<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ä–∫–µ—Ç z≈Ç</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #27ae60; --bg: #ffffff; --sec-bg: #f5f5f7; --text: #1a1a1a; --radius: 20px; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 1000; border-bottom: 1px solid #eee;
        }
        .logo { font-weight: 800; font-size: 1.3rem; color: var(--primary); }
        .cart-icon { font-size: 1.6rem; cursor: pointer; position: relative; }
        #badge { position: absolute; top: 0; right: 0; background: #eb5757; color: white; font-size: 0.7rem; min-width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid white; }

        .categories { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px 20px; }
        .cat-item { text-align: center; }
        .cat-box { width: 60px; height: 60px; background: var(--sec-bg); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.7rem; margin: 0 auto 5px; }
        .cat-item span { font-size: 0.7rem; font-weight: 600; }

        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 10px 20px 100px; }
        .product-card { border: 1px solid #eee; border-radius: var(--radius); padding: 12px; display: flex; flex-direction: column; }
        .product-img { width: 100%; aspect-ratio: 1/1; object-fit: contain; border-radius: 12px; }
        .price { font-size: 1.1rem; font-weight: 700; margin: 8px 0 4px; color: var(--primary); }
        .name { font-size: 0.85rem; height: 2.4em; overflow: hidden; margin-bottom: 12px; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 12px; font-weight: 700; }

        /* Modal Cart */
        #cart-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; display: none; flex-direction: column; padding: 20px; }
        .modal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cart-list { flex-grow: 1; overflow-y: auto; }
        .cart-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .checkout-btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 1.1rem; font-weight: 700; margin-top: 15px; }

        .footer-btn { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--primary); color: white; padding: 18px; border-radius: 20px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); z-index: 999; }
    </style>
</head>
<body>

<header>
    <div class="logo">MAR–öET</div>
    <div class="cart-icon" onclick="toggleCart(true)">üõí<div id="badge">0</div></div>
</header>

<div class="categories">
    {% for c, e in [("–ö–∞–Ω–∞–ø–∫–∏", "ü•™"), ("–ù–∞–ø–∏—Ç–∫–∏", "ü•§"), ("–î–µ—Å–µ—Ä—Ç—ã", "üç∞"), ("–î—Ä—É–≥–æ–µ", "üì¶")] %}
    <div class="cat-item" onclick="document.getElementById('s-{{c}}').scrollIntoView({behavior:'smooth'})">
        <div class="cat-box">{{e}}</div><span>{{c}}</span>
    </div>
    {% endfor %}
</div>

<div id="catalog">
    {% for cat in ["–ö–∞–Ω–∞–ø–∫–∏", "–ù–∞–ø–∏—Ç–∫–∏", "–î–µ—Å–µ—Ä—Ç—ã", "–î—Ä—É–≥–æ–µ"] %}
    {% set items_in = items | selectattr("category", "equalto", cat) | list %}
    {% if items_in %}
    <h2 id="s-{{cat}}" style="padding: 10px 20px 0; font-size: 1.3rem;">{{cat}}</h2>
    <div class="products-grid">
        {% for i in items_in %}
        <div class="product-card">
            <img src="{{ i.photo_url }}" class="product-img">
            <div class="price">{{ i.price }} z≈Ç</div>
            <div class="name">{{ i.name }}</div>
            <button class="btn-add" onclick="add('{{i.id}}','{{i.name}}',{{i.price}})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}
</div>

<div id="cart-modal">
    <div class="modal-top"><h2>Koszyk</h2><div onclick="toggleCart(false)" style="font-size:1.5rem">‚úï</div></div>
    <div class="cart-list" id="cart-list"></div>
    <div style="padding-top:15px; border-top:1px solid #eee">
        <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.2rem"><span>Total:</span><span id="m-total">0 z≈Ç</span></div>
        <button class="checkout-btn" onclick="send()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
</div>

<div class="footer-btn" id="footer" onclick="toggleCart(true)"><span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span><span id="f-total">0 z≈Ç</span></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    let cart = {};
    const tg = window.Telegram.WebApp;
    tg.expand();

    function add(id, n, p) {
        if(!cart[id]) cart[id] = {n, p, q:0};
        cart[id].q++;
        update();
        tg.HapticFeedback.impactOccurred('light');
    }

    function update() {
        let t = 0, c = 0;
        for(let id in cart) { t += cart[id].p * cart[id].q; c += cart[id].q; }
        document.getElementById('badge').innerText = c;
        document.getElementById('badge').style.display = c > 0 ? 'flex' : 'none';
        document.getElementById('footer').style.display = c > 0 ? 'flex' : 'none';
        document.getElementById('f-total').innerText = t.toFixed(2) + ' z≈Ç';
        document.getElementById('m-total').innerText = t.toFixed(2) + ' z≈Ç';
    }

    function toggleCart(s) {
        if(s) {
            let h = '';
            for(let id in cart) {
                h += `<div class="cart-row"><div><b>${cart[id].n}</b><br>${cart[id].p} z≈Ç</div>
                <div style="display:flex;align-items:center;gap:10px">
                <button onclick="change('${id}',-1)">-</button><b>${cart[id].q}</b><button onclick="change('${id}',1)">+</button>
                </div></div>`;
            }
            document.getElementById('cart-list').innerHTML = h || '<p>–ü—É—Å—Ç–æ</p>';
            document.getElementById('cart-modal').style.display = 'flex';
        } else { document.getElementById('cart-modal').style.display = 'none'; }
    }

    function change(id, d) {
        cart[id].q += d;
        if(cart[id].q <= 0) delete cart[id];
        update(); toggleCart(true);
    }

    function send() {
        if(Object.keys(cart).length === 0) return;
        let items = Object.values(cart).map(i => ({name: i.n, qty: i.q, price: i.p}));
        tg.sendData(JSON.stringify({items, total: document.getElementById('m-total').innerText}));
    }
</script>
</body>
</html>
